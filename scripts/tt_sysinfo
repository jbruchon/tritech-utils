#!/bin/bash

VER="1.16.4"
VERDATE="2016-03-04"

#echo "Tritech system info tool $VER, updated on $VERDATE"
#echo "Copyright (c) by Jody Bruchon <jody@jodybruchon.com>"

# Presents system information

. tss__common
. tss_client

# Verbosity level
V=0
test "$1" = "-v" && V=1

echo "${CCYA}CPU:  $CGRN$(cat /proc/cpuinfo | grep "model name" | sed s/.*:[^A-Za-z]*//g | head -n 1)$COFF ($CBLU$(cat /proc/cpuinfo | grep "model name" | wc -l) cores$COFF)"

tt__read_memory_size

MEMG=$(expr $MEMT / 1024)
MEML=$(expr $MEMT % 1024)
MEML=$(expr $MEML \* 10)
MEML=$(expr $MEML / 512)
MEML=$(expr $MEML \* 5)
test "$MEMT" -lt 1024 && echo "${CPUR}RAM:  $CWHT$MEMT$COFF MB"
test "$MEMT" -gt 1023 && echo "${CPUR}RAM:  $CWHT${MEMG}.${MEML}$COFF GB"

# Calculate the stupid bogus marketing GB size of all hard drives
for X in /sys/block/sd*
	do if [[ -e "$X/device" && "$(cat $X/size 2>/dev/null)" -gt 0 && "$(cat $X/removable 2>/dev/null)" -eq 0 ]]
		then
		Y=$(basename $X)
		SIZE=$(cat "$X/size" 2>/dev/null)
		SIZE=$(expr $SIZE \* 512 / 1000000000)
		SIZETB=$(expr $SIZE / 1000)
		SIZETB2="$SIZETB.$(expr $(expr $SIZE - $SIZETB \* 1000) / 100)"
		DN=$(hdparm -I /dev/$Y 2>/dev/null | grep 'Model Number:' | sed 's/[^:]*[^a-zA-Z0-9]*//;s/ *$//g')
		DSN=$(hdparm -I /dev/$Y 2>/dev/null | grep 'Serial Number:' | sed 's/[^:]*[^a-zA-Z0-9]*//;s/ *$//g')
		test "$DN" = "" && DN="unknown"
		test "$DSN" = "" && DSN="unknown"
		if [ "$SIZETB" -eq 0 ]
			then echo "$CWHT$Y$COFF:  $CPUR$SIZE$COFF GB  (Model $DN, Serial $DSN)"
			else echo "$CWHT$Y$COFF:  $CPUR$SIZETB2$COFF TB    (Model $DN, Serial $DSN)"
		fi
		tt__hdd_smart_status $Y
	fi
done

VGA="$(lspci -mm | grep "VGA compatible" | cut -d\" -f6 | sed 's/^ *//' | head -n 1)"
test $V -gt 0 && echo "${CPUR}VGA:  $VGA$COFF"
unset BIOS
for X in "Vendor:" "Version:" "Release Date:"
	do BIOS="$BIOS $(dmidecode -t bios 2>/dev/null | grep -m 1 "$X" | cut -d: -f2)"
done
BIOS="$(echo "$BIOS" | sed 's/^ *//')"
test $V -gt 0 && echo "${CPUR}ROM:  $BIOS$COFF"

unset NET
for X in /sys/class/net/eth* /sys/class/net/en*
	do if [ "$(cat $X/carrier 2>/dev/null)" = "1" ]
		then NET="$NET  $CWHT$(basename $X):"
		LINK="$(cat $X/speed 2>/dev/null)"
		case $LINK in
			1000) NET="$NET ${CGRN}1000 Mbps$COFF" ;;
			100) NET="$NET ${CYEL}100 Mbps$COFF" ;;
			10) NET="$NET ${CRED}10 Mbps$COFF" ;;
			*) NET="$NET ${CCYA}Unsure ($LINK)$COFF" ;;
		esac
	fi
done
if [ -z "$NET" ]
	then echo "${CYEL}NET:  No ethernet adapter detected.$COFF"
	else echo "${CGRN}NET:$NET$COFF"
fi


# If TSS client available, try to display TSS record for system.
if [[ "$TSS_CLIENT" = "1" && ! -z "$PCID" ]]
	then
	echo "${CBLU}TSS:  ${CPUR}PCID: $CWHT$PCID  ${CPUR}WOID: $CWHT$WOID  ${CPUR}Model: $CWHT$MODEL$COFF"
	echo "${CBLU}TSS:  ${CPUR}Name: $CWHT$NAME  ${CPUR}Company: $CWHT$COMPANY$COFF"
	echo "${CBLU}TSS:  ${CPUR}Phone Numbers: $CWHT$PHONE1  $PHONE2  $PHONE3$COFF"
	unset DIAGS NOTES
	for X in A_HDD A_BURNIN A_CLEANER A_BACKUP A_VIRUS A_MBR A_CDROM
		do if [ "$(eval echo "\$$X")" = "1" ]
			then DIAGS="$(echo "$X" | sed s/._//) $DIAGS"
		fi
	done
	for X in N_OVERHEAT N_SPACE N_SLOWAV N_LOWRAM N_BADRAM N_BADHDD N_VIRUS
		do if [ "$(eval echo "\$$X")" = "1" ]
			then NOTES="$(echo "$X" | sed s/._//) $NOTES"
		fi
	done
	# Colorize work approval tag
	test "$N_APPROVE" = "1" && NOTES="$BGGRN$CWHT Approved $COFF$BGBLK $NOTES"
	test -d "/mnt/cifs/customer_backups/$WOID" && NOTES="$BGYEL$CWHT Backup $COFF$BGBLK $NOTES"

	test -z "$DIAGS" && DIAGS="(none) "
	test -z "$NOTES" && NOTES="(none) "
	echo "${CBLU}TSS:  ${CCYA}Diags: $CWHT$DIAGS$COFF ${CCYA}Notes: $CWHT$NOTES$COFF"
	echo "${CBLU}TSS:  ${CCYA}OS:    $CWHT$OS$COFF"
	if [ -n "$PROBDESC" ]
		then
		echo -e "${CBLU}TSS:  ${CCYA}----- Problem Description -----$COFF"
		echo -n "$PROBDESC" | fold -s -w 60 | sed "s/^/${CBLU}TSS:  $CWHT/"
		echo "$COFF"
		else
		echo -e "${CBLU}TSS:  ${CCYA}- Problem Description is Missing -$COFF"
	fi
	if [ -n "$CUSTNOTES" ]
		then
		echo -e "${CBLU}TSS:  ${CCYA}----- Customer-Visible Notes -----$COFF"
		echo -n "$CUSTNOTES" | fold -s -w 60 | sed "s/^/${CBLU}TSS:  $CWHT/"
		echo "$COFF"
		else
		echo -e "${CBLU}TSS:  ${CCYA}- No Customer-Visible Notes Present -$COFF"
	fi
	if [ -n "$TECHNOTES" ]
		then
		echo -e "${CBLU}TSS:  ${CCYA}----- Technician-Only Notes -----$COFF"
		echo -n "$TECHNOTES" | fold -s -w 60 | sed "s/^/${CBLU}TSS:  $CWHT/"
		echo "$COFF"
		else
		echo -e "${CBLU}TSS:  ${CCYA}- No Technician-Only Notes Present -$COFF"
	fi
fi

# If this is a Windows 8 or higher machine with a UEFI BIOS embedded
# product key, show the key.
MSDM=/sys/firmware/acpi/tables/MSDM
if [ -e $MSDM ]
	then echo "${CYEL}WIN:  $CWHT$(strings $MSDM | tail -n 1)$COFF"
fi
